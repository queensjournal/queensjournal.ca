{% extends 'base.html' %}
{% load navigation %}
{% load typogrify %}
{% load custom_html %}
{% load sanitize %}
{% load comparison %}
{% load poll_tags %}
{% load flash %}
{% load lists %}
{% load tags %}
{% load shorturl %}

{% block facebook %}
<meta property="og:title" content="{{ story.head }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{% shorturl story %}" />
<meta property="og:image" content="{{ story.first_photo.thumbnail_image.url }}" />
<meta property="og:site_name" content="The Queen&#039;s Journal" />
<meta property="fb:admins" content="1653600047" />
{% endblock facebook %}

{% block headcode %}
<script src="{{ MEDIA_URL }}global/js/jquery-1.4.js" type="text/javascript"></script>
<link rel="alternate stylesheet" type="text/css" href="{{ MEDIA_URL }}global/styles/journal_print_preview.css" media="screen" title="Print Preview" />
<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}global/styles/journal_print.css" media="print" />
{% if story.storyphoto_set.all|length > 1 %}
<script src="{{ MEDIA_URL }}global/js/jquery.nivo.slider.pack.js" type="text/javascript"></script>
<link rel="stylesheet" href="{{ MEDIA_URL }}global/styles/nivo-slider.css" type="text/css" media="screen" />
{% endif %}
{% if story.gallery_set.all %}
<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}js/fancybox/jquery.fancybox-1.3.4.css" media="screen" />
<script type="text/javascript" src="{{ MEDIA_URL }}js/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
{% endif %}
<script type="text/javascript" src="{{ MEDIA_URL }}js/print_preview.js"></script>
{% endblock headcode %}

{% block title %}{{ story.head }} - {{ block.super }}{% endblock title %}

{% block header-type %}secondary{% endblock header-type %}
	{% block header-img %}logo_inside.gif{% endblock header-img %}
	{% block dateline %}{{ story.issue.pub_date|date:"F j, Y" }}{% endblock dateline %}
	{% if story.issue %}
		{% block issueline %}Vol. {{ story.issue.volume.volume}}, Issue {{ story.issue.issue }}{% endblock issueline %}
	{% endif %}

	{% block menu-stories %}
		{% other_stories story.section story.issue %}
		{% if other_stories %}
			<p class="menu-label">Other stories in {{ story.section.name }}</p>
			<ul>
			{% for other_story in other_stories %}
				<li><a href="{{ other_story.get_absolute_url }}">{{ other_story.head }}</a></li>
			{% endfor %}
		{% endif %}
		</ul>
	{% endblock menu-stories %}
		
	{% block layout-type %} span-18 colborder{% endblock %}
	{% block breadcrumb %}{% endblock breadcrumb %}
	{% block actions %}
		<div id="actions"><p><span id="actions-email" class="action"><a href="{{ story.get_absolute_url }}email/">e-mail <img src="{{ MEDIA_URL }}global/icon_email.gif" /></a>&emsp;<a href="javascript:print_preview()">print <img src="{{ MEDIA_URL }}global/icon_print.gif" /></a></span></p></div>
	{% endblock actions %}
	{% block content %}
		<!-- google_ad_section_start -->
		<div id="story" class="story clearfix">
			<h1 class="story-head">{{ story.head|stripspace|convert_entities|widont }}</h1>
			<h4 class="story-deck">{{ story.kick|stripspace|convert_entities|widont }}</h4>
			{{ story.pub_date|date:"jS F Y" }}
			<p class="story-byline">{% ifnotequal story.list_authors '[no author]' %}By {{ story.list_authors }}{% endifnotequal %}</p>	  
			
			{% if story.show_headshots %}
				{% for author in story.storyauthor_set.all %}
					<div class="headshot"><img src="{{ author.author.headshot.display.url }}" /><br/>
					{{ author.author.name }}</div>
				{% endfor %}
			{% endif %}
				
			{% if story.storyphoto_set.all|length > 1 %}
			<div id="slider-wrapper" class="story">
				<div id="slider" class="nivoSlider" style="margin-right: 0px;">
				{% for pwrapper in story.storyphoto_set.all %}
					<img src="{{ pwrapper.photo.display.url }}" class="slideshow-featured-img" title="#caption{{ pwrapper.photo.id }}" />
				{% endfor %}
				</div>
				{% for pwrapper in story.storyphoto_set.all %}
				<div id="caption{{ pwrapper.photo.id }}" class="nivo-html-caption">
					{{ pwrapper.photo.caption }}{% ifnotequal pwrapper.photo.list_photographer '[no credit]' %} ({{ pwrapper.photo.list_photographer }}){% endifnotequal %}
				</div>
				{% endfor %}
			</div>
			{% endif %}
			
			{% if story.storyphoto_set.all|length = 1 %}
			<div id="slider-single-wrapper" class="story">
				{% for pwrapper in story.storyphoto_set.all %}
					<img src="{{ pwrapper.photo.display.url }}" class="story-photo" />
					<p class="story-caption">{{ pwrapper.photo.caption }}{% ifnotequal pwrapper.photo.list_photographer '[no credit]' %} ({{ pwrapper.photo.list_photographer }}){% endifnotequal %}</p>
				{% endfor %}
			</div>
			{% endif %}
			
			<div id="story-socmedia">
				<p class="label">Share<p>
					<hr>
				<script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script><fb:like href="{% shorturl story%}" layout="button_count" show_faces="false" width="100" font=""></fb:like>
				<br/>
				<a href="http://twitter.com/share" class="twitter-share-button" data-url="{% shorturl story %}" data-count="horizontal" data-via="queensjournal">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

				{% tags_for_object story as tags %}
				{% if tags %}
				<h4>Article tags:</h4>
				<ul>
				{% for tag in tags %}
					<li><a href="/tag/{{tag.name|slugify}}/">{{ tag }}</a></li>
				{% endfor %}
				</ul>
				{% endif %}
				<br/>
				Short URL:
				<form action="" method="get">
					<input type="text" id="shorturl" name="shorturl" value="{% shorturl story %}" />
				</form>
				{% revcanonical story %}

			</div>
			
			{% if story.has_inlines %}
				<div class="story-inlines">
				{% for factbox in story.factbox_set.all %}
				{% if not factbox.full_width %}
					<div class="inline-container factbox">
						<h4>{{ factbox.head|widont }}</h4>
						{{ factbox.body|sanitize:"h4 strong em a ul li table tr td tbody thead tfoot th,"|typogrify|convert_entities|linebreakswithcode }}
						{% if factbox.source %}<p class="factbox-source">&mdash;{{ factbox.source }}</p>{% endif %}
					</div>
				{% endif %}
				{% endfor %}
				{% for document in story.document_set.all %}
					<div class="inline-container document">
						<h4>{{ document.head|widont }}</h4>
						{% if document.body %}<p>{{ document.body|typogrify|convert_entities }}</p>{% endif %}
						<ul>
						{% for file in document.files.all %}
							<li>{% filter widont %}<a href="{{ file.get_file_obj_url }}">{{ file.name }}</a> <span class="doc-details">({{ file.get_file_obj_size|filesizeformat }})</span>{% endfilter %}{% if file.caption %}<p class="doc-caption">{{ file.caption }}</p>{% endif %}</li>
						{% endfor %}
						</ul>
					</div>
				{% endfor %}
				{% for poll in story.storypoll_set.all %}
					<div class="inline-container poll">
						<h4>Poll</h4>
						<p id="poll-question">{{ poll.poll.question }}</p>
						{% pollflash poll.poll.id %}
							{% ifequal pollmsg.params.type 'voteflood' %}{% ifequal pollmsg.poll poll.poll.id %}<p><strong>{{ pollmsg.msg }}</strong></p>{% endifequal %}{% endifequal %}
						{% endpollflash %}
						{% if poll.poll.id|in_list:request.session.vote or request.GET.results or not poll.poll.is_active %}
						{% if not poll.poll.is_active %}
							<p><strong>Voting on this poll is closed.</strong></p>
						{% endif %}
						<ul id="poll-results">
							{% for choice in poll.poll.choice_set.all %}
							<li class="clearfix"><p>{{ choice.choice }}</p>
							<p class="result-number">{{ choice.vote_set.count }}</p>
							<div class="result-bar-back">
								<div class="result-bar-interval"></div>
								<div class="result-bar-interval"></div>
								<div class="result-bar-interval"></div>
								<div class="result-bar-interval"></div>
							{% ifnotequal choice.vote_set.count 0 %}
								<div class="result-bar" style="width: {% widthratio choice.vote_set.count poll.poll.total_votes 118 %}px;"></div>
							{% endifnotequal %}
							</div>
							</li>
							{% endfor %}
						{% else %}
						<form action="{% url polls.views.poll_vote poll.poll.id %}" method="post">
							{% poll_form poll.poll.id as form %}
							{{ form.choice }}
							<input type="hidden" name="url" value="{{ request.get_full_path }}" />
							<button type="submit">Vote!</button> <a href="{{ request.get_full_path }}?results=1">View results</a>
						</form>
						{% endif %}
					</div>
					{% endfor %}
				</div>
			{% endif %}
			<div class="story-content">
				
			{{ story.content|typogrify|convert_entities|linebreakswithcode|safe|urlizetrunc:50 }}
			
			{% if story.gallery_set.all %}
				{% for gallery in story.gallery_set.all %}
					<div class="gallery-container clearfix">
						<h4>{{ gallery.name|widont }}</h4>
						<div class="thumbs-container">
						{% for image in gallery.images.all %}
						<a class="gallery" rel="{{ gallery.name|slugify }}" href="{{ image.gallery_image.url }}"{% if image.caption %} title="{{ image.caption|escape }} ({{ image.list_photographer }})"{% endif %}><img src="{{ image.thumbnail_image.url }}" alt="{{ image.caption }}"/></a>
						{% endfor %}
						</div>
					</div>
				{% endfor %}
			{% endif %}
			{% if story.has_wide_inlines %}
				{% for factbox in story.factbox_set.all %}
				{% if factbox.full_width %}
					<div class="inline-container factbox">
						<h4>{{ factbox.head|widont }}</h4>
						{{ factbox.body|sanitize:"h4 strong em a ul li table tr td th tbody thead tfoot,"|typogrify|convert_entities|linebreakswithcode }}
						{% if factbox.source %}<p class="factbox-source">&mdash;{{ factbox.source }}</p>{% endif %}
					</div>
				{% endif %}
				{% endfor %}
			{% endif %}
			
			{% if story.enable_comments %}
				{% load disqus_tags %}
				{% disqus_show_comments %}
			{% endif %}
			
			</div>
		</div>
	{% endblock content %}
	<!-- google_ad_section_end -->


{% block footercode %}
{% if story.storyphoto_set.all|length > 1 %}
    $(window).load(function() {
        $('#slider').nivoSlider({
			directionNav:true,
			directionNavHide:false,
			manualAdvance:true,
			controlNav:false,
			effect:'slideInLeft',
			captionOpacity:1,
		});
    });
{% endif %}
{% if story.gallery_set.all %}
$(document).ready(function() {
	$("a.gallery").fancybox({
		'titlePosition'  : 'inside'
	});
	$("div.thumbs-container a:nth-child(6n)").addClass('last')
});
{% endif %}
$("#shorturl").focus(function(){
    // Select input field contents
    this.select();
});
{% endblock footercode %}